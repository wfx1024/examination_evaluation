<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>全国大中小教材数据库</title>
    <link rel="stylesheet" href="/kspj/static/layuiadmin/layui/css/layui.css">
</head>
<body>

<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-form layui-card-header layuiadmin-card-header-auto" lay-filter="form-search">
            <div class="layui-form-item">
                <!--表格检索-->
                <div class="layui-inline">
                    <label class="layui-form-label">教材名称</label>
                    <div class="layui-input-inline">
                        <input type="text" id="name" name="name" placeholder="请输入" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">书号</label>
                    <div class="layui-input-inline">
                        <input type="text" id="isbn" name="isbn" placeholder="请输入" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">作者</label>
                    <div class="layui-input-inline">
                        <input type="text" id="author" name="author" placeholder="请输入" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">语种</label>
                    <div class="layui-input-inline">
                        <select id="language" name="language">
                            <option value="">请选择</option>
                        </select>
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">教材类型</label>
                    <div class="layui-input-inline">
                        <select id="textbookType" name="textbookType">
                            <option value="">请选择</option>
                        </select>
                    </div>
                </div>
                <div class="layui-inline">
                    <button class="layui-btn layuiadmin-btn-list" lay-submit lay-filter="btn-search">
                        <i class="layui-icon layui-icon-search layuiadmin-button-btn"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="layui-card-body">
            <div>
                <button class="layui-btn layuiadmin-btn-list" data-type="batchdel">删除</button>
                <button class="layui-btn layuiadmin-btn-list" data-type="add">新增</button>
                <button class="layui-btn layuiadmin-btn-list" data-type="stat">统计报表</button>
            </div>
            <table id="tbl-book-list" lay-filter="tbl-book-list"></table>
            <script type="text/html" id="toolbar-user-list">
                <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="edit"><i class="layui-icon layui-icon-edit"></i>编辑</a>
                <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del"><i class="layui-icon layui-icon-delete"></i>删除</a>
            </script>
        </div>
    </div>
</div>
<script src="/kspj/static/layuiadmin/layui/layui.js"></script>

<script >
layui.config({
    base:  '/kspj/static/layuiadmin/'  //静态资源所在路径
}).extend({
    index: 'lib/index'  //主模块入口
}).use(['layer','index','form','table','laydate'], function () {
    var $ = layui.$  //JQuery
        ,layer = layui.layer
        ,form = layui.form
        ,table = layui.table
        ,laydate = layui.laydate;

    var name = $.trim($("#name").val());
    var isbn = $.trim($("#isbn").val());
    var author = $.trim($("#author").val());
    var textbookType = $.trim($("#textbookType").val());
    var language = $.trim($("#language").val());
    var queryParams = {
        "name" : name,
        "isbn" : isbn,
        "author" : author,
        "textbookType" : textbookType,
        "language" : language
    };

//用户列表
    table.render({
        elem: '#tbl-book-list'
        ,url: '/kspj/textbook/list-page'
        ,where: queryParams
        ,cols: [
            [
                {type: 'checkbox', fixed: 'left'}
                ,{field: 'id', width: 70, title: '序号', sort: true, fixed: 'left'}
                ,{field: 'name', width: 140, title: '教材名称', minWidth: 100, fixed: 'left'}
                ,{field: 'author1', width: 140, title: '主要作者', minWidth: 100, fixed: 'left'}
                ,{field: 'isbn', width: 140, title: '书号', minWidth: 100}
                ,{field: 'publisher', width: 140, title: '出版单位'}
                ,{field: 'authorMode1', width: 140, title: '编著方式'}
                ,{field: 'authorUnit1', width: 140, title: '作者单位'}
                ,{field: 'authorNationality1', width: 140, title: '作者国籍'}
                ,{field: 'edition', width: 60, title: '版次'}
                ,{field: 'editionDate', width: 180, title: '版次日期'}
                ,{field: 'language', width: 100, title: '语种'}
                ,{field: 'textbookType1', width: 160, title: '教材类型'}
                ,{field: 'publishForm', width: 140, title: '教材出版形态'}
                ,{field: 'isCollege', width: 160, title: '是否高校'}
                ,{field: 'projectSituation', width: 160, title: '国家级立项情况  '}
                ,{field: 'otherSituation', width: 160, title: '其他立项情况'}
                ,{field: 'prizeSituation', width: 160, title: '国家级获奖情况'}
                ,{field: 'otherPrizeSituation', width: 140, title: '其他获奖情况'}
                ,{field: 'status', width: 140, title: '提交状态'}
                ,{field: 'createUser', width: 140, title: '创建人'}
                ,{field: 'updateUser', width: 140, title: '更新人'}
                ,{title: '操作', minWidth: 250, align: 'center', fixed: 'right', toolbar: '#toolbar-user-list'}
            ]
        ]
        ,page: true
        ,limit: 15
        ,limits: [10, 15, 20, 25, 30]
        ,text: {
            none: '未查询到匹配的记录' //默认：无数据。注：该属性为 layui 2.2.5 开始新增
        }
    });

    var active = {
        batchdel: function(){
            var checkStatus = table.checkStatus('tbl-book-list')
                ,checkData = checkStatus.data; //得到选中的数据
            if(checkData.length === 0){
                return layer.msg('请选择数据');
            }
            layer.confirm('确定删除所选的【'+checkData.length+'】个教材？', function(index) {
                var ids = [];
                $.each(checkData, function(i, v){
                    ids.push(v.id);
                });
                $.ajax({
                    type: "POST",
                    timeout: 5000,
                    dataType: "json",
                    url: '/kspj/textbook/delete',
                    data: {"ids":ids},
                    success: function(d){
                        if(d.code=="0"){
                            layer.msg('教材信息删除成功！', {icon: 1});
                            table.reload('tbl-book-list');
                        }else{
                            layer.msg('教材信息删除失败：'+d.msg, {icon: 2});
                        }
                    },
                    error: function(XMLHttpRequest,textStatus,errorThrown){
                        layer.msg('教材信息删除失败：'+textStatus, {icon: 2});
                    },
                    complete: function(){
                        layer.close(index);
                    }
                });
            });
        },
        add:function() {
            var frame = layer.open({
                type: 2
                ,title: '查看'
                ,content:   '/kspj/view/plus/textbook/edit.html'
                ,maxmin: true
                ,area: ['50%', '50%']
                ,btn: ['确定', '取消']
                ,yes: function(index, layero){
                    var submit = layero.find('iframe').contents().find("#btn-save");
                    submit.trigger('click');
                }
            })
            layer.full(frame);
        },
        stat:function () {
            var frame = layer.open({
                type: 2
                ,title: '统计报表'
                ,content:   '/kspj/textbook/toStat'
                ,maxmin: true
                ,area: ['100%', '100%']
            })
            layer.full(frame);
        }
    };


    //监听工具条
    table.on('tool(tbl-book-list)', function(obj){
        var data = obj.data;
        if(obj.event === 'del'){
            layer.confirm('确定删除此动态【'+data.name+'】？', function(index){
                var ids = [];
                ids.push(data.id);
                $.ajax({
                    type: "POST",
                    timeout: 5000,
                    dataType: "json",
                    url:   "/kspj/textbook/delete",
                    data: {"ids":ids},
                    success: function(d){
                        if(d.code=="0"){
                            layer.msg('动态信息删除成功！', {icon: 1});
                            table.reload('tbl-book-list');
                        }else{
                            layer.msg('动态信息删除失败：'+d.msg, {icon: 2});
                        }
                    },
                    error: function(XMLHttpRequest,textStatus,errorThrown){
                        layer.msg('动态信息删除失败：'+textStatus, {icon: 2});
                    },
                    complete: function(){
                        layer.close(index);
                    }
                });
            });
        }else if(obj.event === 'edit'){
            var frame = layer.open({
                type: 2
                ,title: '查看'
                ,content:   '/kspj/view/plus/textbook/edit.html?id=' + data.id
                ,maxmin: true
                ,area: ['50%', '50%']
                ,btn: ['确定', '取消']
                ,yes: function(index, layero){
                    var submit = layero.find('iframe').contents().find("#btn-save");
                    submit.trigger('click');
                }
            });
            layer.full(frame);
        }
    });

    //监听搜索
    form.on('submit(btn-search)', function(data){
        var field = data.field;
        // 查询参数去空格
        $.each(field, function(k, v) {
            field[k] = $.trim(v);
        });
        //执行重载
        table.reload('tbl-book-list', {
            where: field,
            page: {
                curr: 1
            }
        });
    });

    $('.layui-btn.layuiadmin-btn-list').on('click', function(){
        var type = $(this).data('type');
        active[type] ? active[type].call(this) : '';
    });




    var initPage = function(){
        //初始化下拉框
        var params = {};
        $.ajax({
            type: "POST",
            // timeout: 3000,
            dataType: "json",
            url: "/kspj/textbook/type",
            data: params,
            success: function(d){
                if(d.code=="0"){
                    var select = $("#textbookType");
                    $.each(d.data, function (i, v) {
                        select.append("<option value='"+v+"'>"+v+"</option>");
                    });
                    form.render("select", "form-search");
                }else{
                    layer.msg('类型信息获取失败！', {icon: 2});
                }
            },
            error: function(XMLHttpRequest,textStatus,errorThrown){
                layer.msg('类型信息获取失败！', {icon: 2});
            },
            complete: function(){
            }
        });

        $.ajax({
            type: "POST",
            // timeout: 3000,
            dataType: "json",
            url:   "/kspj/textbook/language",
            data: params,
            success: function(d){
                if(d.code=="0"){
                    var select = $("#language");
                    $.each(d.data, function (i, v) {
                        select.append("<option value='"+v+"'>"+v+"</option>");
                    });
                    form.render("select", "form-search");
                }else{
                    layer.msg('语种信息获取失败！', {icon: 2});
                }
            },
            error: function(XMLHttpRequest,textStatus,errorThrown){
                layer.msg('语种信息获取失败！', {icon: 2});
            },
            complete: function(){
            }
        });
    }

    $(function () {
        initPage();
    })

})
</script>
</body>
</html>